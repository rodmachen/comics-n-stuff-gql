# Claude Session — 2026-02-23

## Project: comics-n-stuff-gql

---

### Topic: GraphQL query variable bug

**User:** What's wrong with this query?
```graphql
query ExampleQuery($search: String) {
  allSeries(search: "batman") { ... }
}
```

**Resolution:** The query declared `$search: String` as a variable but passed a hardcoded string literal `"batman"` instead of using `$search`. Fixed to `allSeries(search: $search)`.

---

### Topic: ECONNREFUSED / Prisma database connection error

**Error:**
```
PrismaClientKnownRequestError: Invalid `prisma.series.findMany()` invocation
code: "ECONNREFUSED"
```

**Root cause:** Database connectivity failure — Prisma could not reach PostgreSQL. Traced to Railway environment variables not being properly set (Railway's "Suggested Variables" UI shows template values from `.env.example`, not real credentials).

**Additional finding:** The `DIRECT_DATABASE_URL` in `.env` had a malformed URL — an extra `/` before the password:
```
# Wrong
postgresql://postgres:/password@host:5432/db
# Correct
postgresql://postgres:password@host:5432/db
```

---

### Topic: CORS error from Apollo Studio / diagnose-endpoint

**Command run:**
```
npx diagnose-endpoint@1.1.0 --endpoint='https://comics-n-stuff-gql-production.up.railway.app/graphql'
```

**Error:** `POST response missing 'access-control-allow-origin' header`

**Root cause:** `CORS_ORIGINS` in Railway was set to the `.env.example` placeholder (`https://your-app.vercel.app,...`), which didn't include `https://studio.apollographql.com`.

**Resolution options:**
1. Add `https://studio.apollographql.com` to `CORS_ORIGINS`
2. Remove `CORS_ORIGINS` entirely to fall back to `*` (wildcard)

---

### Topic: Updated plans/deploy-api.md

Added four `[POST-DEPLOY]` notes to the plan:
1. Railway "Suggested Variables" are templates from `.env.example` — must be replaced with real credentials
2. `NODE_ENV` defaults to `development` in the template — must be set to `production`
3. `DIRECT_DATABASE_URL` extra-slash typo causes misleading `ECONNREFUSED` errors
4. `CORS_ORIGINS` must include `https://studio.apollographql.com` (or be unset) to use Apollo Studio


---

### Topic: GraphQL query — unused variable bug

**User question:** What's wrong with this query?
```graphql
query ExampleQuery($search: String) {
  allSeries(search: "batman") {
    items { id name sortName ... }
  }
}
```

**Resolution:** The variable `$search: String` was declared but never used — the resolver received the hardcoded literal `"batman"` instead. Fixed by replacing `search: "batman"` with `search: $search`.

---

### Topic: ECONNREFUSED — Prisma can't reach the database after deploy

**Error:**
```
PrismaClientKnownRequestError
code: "ECONNREFUSED"
meta: { modelName: "Series" }
```

**Root causes identified:**
1. **Railway "Suggested Variables" are templates** — Railway pre-fills the Variables UI from `.env.example`. The values shown (including the Supabase URLs) are placeholders and must be replaced with real credentials before deploying.
2. **`NODE_ENV` defaults to `development`** — The `.env.example` template sets `NODE_ENV=development`. Must be changed to `production` in Railway.
3. **Malformed `DIRECT_DATABASE_URL`** — The `.env` file had an extra `/` before the password, making an invalid URL that causes a connection refusal that looks like a network issue:
   ```
   # Wrong
   postgresql://postgres:/pLLD7YKD...@db.xxxx.supabase.co:5432/postgres
   # Correct
   postgresql://postgres:pLLD7YKD...@db.xxxx.supabase.co:5432/postgres
   ```

---

### Topic: CORS error when testing via Apollo Studio

**Command:**
```
npx diagnose-endpoint@1.1.0 --endpoint='https://comics-n-stuff-gql-production.up.railway.app/graphql'
```

**Error:** `POST response missing 'access-control-allow-origin' header`

**Root cause:** `CORS_ORIGINS` in Railway was still set to the placeholder value `https://your-app.vercel.app,...` (copied from `.env.example`), which doesn't include `https://studio.apollographql.com`.

**Resolution options:**
1. Add `https://studio.apollographql.com` to `CORS_ORIGINS`
2. Delete `CORS_ORIGINS` entirely — server defaults to `*` (wildcard)

---

### Topic: Updated plans/deploy-api.md with post-deployment lessons

Added four `[POST-DEPLOY]` callout blocks to the plan:
1. Railway "Suggested Variables" are `.env.example` templates — not real credentials
2. `NODE_ENV` must be set to `production` (template defaults to `development`)
3. Extra `/` in `DIRECT_DATABASE_URL` causes `ECONNREFUSED` (easy to miss)
4. `CORS_ORIGINS` must include `https://studio.apollographql.com` to use Apollo Studio for testing, or be unset to allow all origins
